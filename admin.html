<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å - The International</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .chart-bar {
            height: 200px;
            background: linear-gradient(180deg, #8b5cf6 0%, #6d28d9 100%);
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <nav class="bg-gray-800 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-8">
                    <a href="index.html" class="text-2xl font-black text-purple-400">TI Admin</a>
                    <div class="hidden md:flex space-x-6">
                        <a href="admin.html" class="text-white hover:text-purple-400 transition">–ü–∞–Ω–µ–ª—å</a>
                        <a href="admin-users.html" class="text-gray-300 hover:text-white transition">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
                        <a href="admin-orders.html" class="text-gray-300 hover:text-white transition">–ó–∞–∫–∞–∑—ã</a>
                    </div>
                </div>
                <button id="logout-btn" class="px-6 py-2 bg-red-600 rounded-lg hover:bg-red-700 transition font-semibold">
                    –í—ã—Ö–æ–¥
                </button>
            </div>
        </div>
    </nav>

    <!-- –û—à–∏–±–∫–∏ –∏ —É—Å–ø–µ—Ö -->
    <div id="error-message" class="hidden fixed top-4 right-4 bg-red-900 border border-red-700 rounded-lg text-red-200 p-4 max-w-md z-50"></div>
    <div id="success-message" class="hidden fixed top-4 right-4 bg-green-900 border border-green-700 rounded-lg text-green-200 p-4 max-w-md z-50"></div>

    <div class="container mx-auto px-6 py-8">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="mb-8">
            <h1 class="text-4xl font-black mb-2">–ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</h1>
            <p class="text-gray-400">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∞–π—Ç–æ–º The International</p>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                <div class="text-gray-400 text-sm mb-2">üë• –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                <div class="text-3xl font-bold" id="total-users">0</div>
            </div>

            <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                <div class="text-gray-400 text-sm mb-2">üì¶ –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
                <div class="text-3xl font-bold" id="total-orders">0</div>
            </div>

            <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                <div class="text-gray-400 text-sm mb-2">üí∞ –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞</div>
                <div class="text-3xl font-bold" id="total-revenue">$0</div>
            </div>

            <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                <div class="text-gray-400 text-sm mb-2">‚è±Ô∏è –°—Ç–∞—Ç—É—Å</div>
                <div class="text-3xl font-bold text-green-400">‚úì Online</div>
            </div>
        </div>

        <!-- –ù–µ–¥–∞–≤–Ω–∏–µ –∑–∞–∫–∞–∑—ã -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 bg-gray-800 p-6 rounded-lg border border-gray-700">
                <h2 class="text-xl font-bold mb-4">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–∫–∞–∑—ã</h2>
                <div id="recent-orders" class="space-y-2 max-h-96 overflow-y-auto">
                    <div class="text-gray-400 text-center py-4">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</div>
                </div>
            </div>

            <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
            <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                <h2 class="text-xl font-bold mb-4">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h2>
                <div class="space-y-3">
                    <a href="admin-users.html" class="block w-full bg-purple-600 hover:bg-purple-700 p-3 rounded-lg text-center transition">
                        üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
                    </a>
                    <a href="admin-orders.html" class="block w-full bg-blue-600 hover:bg-blue-700 p-3 rounded-lg text-center transition">
                        üì¶ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏
                    </a>
                    <a href="index.html" class="block w-full bg-gray-700 hover:bg-gray-600 p-3 rounded-lg text-center transition">
                        üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏...');
        
        try {
            const { isAdmin, getAdminStats, onOrdersChange } = await import('./admin.js');
            const { onAuthChange, logoutUser } = await import('./auth.js');

            let isUserAdmin = false;

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∞
            onAuthChange(async (user) => {
                if (!user) {
                    console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –ª–æ–≥–∏–Ω');
                    window.location.href = 'login.html';
                    return;
                }

                console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∞ –¥–ª—è:', user.email);
                isUserAdmin = await isAdmin(user.uid);
                console.log('–Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ –∞–¥–º–∏–Ω–æ–º:', isUserAdmin);
                
                if (!isUserAdmin) {
                    console.log('–ù–µ —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–æ–º, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å');
                    window.location.href = 'profile.html';
                    return;
                }

                console.log('–ê–¥–º–∏–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω, –∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É');
                // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                loadStats();
                loadRecentOrders();
            });

            // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            async function loadStats() {
                console.log('–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...');
                try {
                    const { getAdminStats } = await import('./admin.js');
                    const result = await getAdminStats();
                    
                    console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', result);
                    
                    if (result.success) {
                        const stats = result.data;
                        document.getElementById('total-users').textContent = stats.totalUsers || 0;
                        document.getElementById('total-orders').textContent = stats.totalOrders || 0;
                        document.getElementById('total-revenue').textContent = '$' + (stats.totalRevenue || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                        console.log('‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
                    } else {
                        console.error('–û—à–∏–±–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', result.error);
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
                }
            }

            // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–∫–∞–∑—ã
            async function loadRecentOrders() {
                console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–∫–∞–∑–æ–≤...');
                try {
                    const { getAllOrders } = await import('./admin.js');
                    const result = await getAllOrders();
                    
                    console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–∫–∞–∑–æ–≤:', result);
                    
                    const container = document.getElementById('recent-orders');
                    
                    if (result.success && result.data.length > 0) {
                        const recent = result.data.slice(-5).reverse();
                        container.innerHTML = recent.map(order => `
                            <div class="bg-gray-700 p-3 rounded-lg text-sm">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="font-bold">#${order.orderId}</div>
                                        <div class="text-gray-400 text-xs mt-1">${new Date(order.createdAt).toLocaleString('ru-RU')}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-bold">$${order.total?.toFixed(2) || '0.00'}</div>
                                        <span class="inline-block px-2 py-1 rounded text-xs mt-1 ${
                                            order.status === 'completed' ? 'bg-green-900 text-green-200' :
                                            order.status === 'pending' ? 'bg-yellow-900 text-yellow-200' :
                                            'bg-gray-600 text-gray-200'
                                        }">
                                            ${order.status === 'completed' ? '‚úì –í—ã–ø–æ–ª–Ω–µ–Ω' : order.status === 'pending' ? '‚è≥ –í –æ–∂–∏–¥–∞–Ω–∏–∏' : '–û—Ç–º–µ–Ω–µ–Ω'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                        console.log('‚úÖ –ó–∞–∫–∞–∑—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', recent.length);
                    } else {
                        container.innerHTML = '<div class="text-gray-400 text-center py-4">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>';
                        console.log('‚ÑπÔ∏è –ó–∞–∫–∞–∑–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–∫–∞–∑–æ–≤:', error);
                    document.getElementById('recent-orders').innerHTML = '<div class="text-red-400 text-center py-4">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
                }
            }

            // –í—ã—Ö–æ–¥
            document.getElementById('logout-btn').addEventListener('click', async () => {
                const result = await logoutUser();
                if (result.success) {
                    console.log('–£—Å–ø–µ—à–Ω—ã–π –≤—ã—Ö–æ–¥');
                    window.location.href = 'login.html';
                }
            });

            console.log('‚úÖ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –≥–æ—Ç–æ–≤–∞');
        } catch (error) {
            console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
            alert('–û—à–∏–±–∫–∞: ' + error.message);
        }
    </script>
</body>
</html>
