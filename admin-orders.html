<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏ - –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <nav class="bg-gray-800 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-8">
                    <a href="admin.html" class="text-2xl font-black text-purple-400">TI Admin</a>
                    <div class="hidden md:flex space-x-6">
                        <a href="admin.html" class="text-gray-300 hover:text-white transition">–ü–∞–Ω–µ–ª—å</a>
                        <a href="admin-users.html" class="text-gray-300 hover:text-white transition">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
                        <a href="admin-orders.html" class="text-white hover:text-purple-400 transition">–ó–∞–∫–∞–∑—ã</a>
                    </div>
                </div>
                <button id="logout-btn" class="px-6 py-2 bg-red-600 rounded-lg hover:bg-red-700 transition font-semibold">
                    –í—ã—Ö–æ–¥
                </button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-6 py-8">
        <h1 class="text-3xl font-black mb-8">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏</h1>

        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="bg-gray-800 p-4 rounded-lg mb-6 border border-gray-700">
            <div class="flex gap-4 flex-wrap">
                <input 
                    type="text" 
                    id="search-input"
                    placeholder="–ü–æ–∏—Å–∫ –ø–æ ID –∑–∞–∫–∞–∑–∞..."
                    class="px-4 py-2 bg-gray-700 rounded text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                >
                <select id="status-filter" class="px-4 py-2 bg-gray-700 rounded text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="pending">‚è≥ –í –æ–∂–∏–¥–∞–Ω–∏–∏</option>
                    <option value="completed">‚úì –í—ã–ø–æ–ª–Ω–µ–Ω</option>
                    <option value="cancelled">‚úó –û—Ç–º–µ–Ω–µ–Ω</option>
                </select>
            </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ -->
        <div id="orders-container" class="space-y-4">
            <div class="text-gray-400 text-center py-8">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</div>
        </div>
    </div>

    <script type="module">
        console.log('–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞–º–∏...');
        
        try {
            console.log('[Orders] –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ admin.js...');
            const adminModule = await import('./admin.js');
            console.log('[Orders] admin.js –∑–∞–≥—Ä—É–∂–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏:', Object.keys(adminModule));
            const { isAdmin, onOrdersChange, updateOrderStatus, deleteOrder } = adminModule;
            console.log('[Orders] ‚úÖ –§—É–Ω–∫—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', { isAdmin: typeof isAdmin, onOrdersChange: typeof onOrdersChange, updateOrderStatus: typeof updateOrderStatus, deleteOrder: typeof deleteOrder });
            const { onAuthChange, logoutUser } = await import('./auth.js');

            let allOrders = [];

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∞
            onAuthChange(async (user) => {
                console.log('[Orders] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', user?.email);
                
                if (!user) {
                    console.log('[Orders] –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –ª–æ–≥–∏–Ω');
                    window.location.href = 'login.html';
                    return;
                }

                console.log('[Orders] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∞...');
                const admin = await isAdmin(user.uid);
                console.log('[Orders] –Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ –∞–¥–º–∏–Ω–æ–º:', admin);
                
                if (!admin) {
                    console.log('[Orders] –ù–µ –∞–¥–º–∏–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å');
                    window.location.href = 'profile.html';
                    return;
                }

                console.log('[Orders] ‚úÖ –ê–¥–º–∏–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω, –∑–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–∫–∞–∑—ã');
                // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–∫–∞–∑—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
                onOrdersChange((orders) => {
                    console.log('[Orders] –ó–∞–∫–∞–∑—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:', orders.length);
                    allOrders = orders;
                    renderOrders(orders);
                });
            });

            // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∑–∞–∫–∞–∑—ã
            function renderOrders(orders) {
                const container = document.getElementById('orders-container');
                
                if (orders.length === 0) {
                    container.innerHTML = '<div class="text-gray-400 text-center py-8">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>';
                    return;
                }

                container.innerHTML = orders.map(order => `
                    <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-4">
                            <div>
                                <div class="text-gray-400 text-sm">ID –∑–∞–∫–∞–∑–∞</div>
                                <div class="font-mono font-bold text-sm">${order.orderId || '-'}</div>
                            </div>
                            <div>
                                <div class="text-gray-400 text-sm">–û—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
                                <div class="font-mono text-sm">${order.userId?.substring(0, 12) || '-'}...</div>
                            </div>
                            <div>
                                <div class="text-gray-400 text-sm">–î–∞—Ç–∞</div>
                                <div class="text-sm">${new Date(order.createdAt).toLocaleString('ru-RU')}</div>
                            </div>
                            <div>
                                <div class="text-gray-400 text-sm">–°—É–º–º–∞</div>
                                <div class="text-lg font-bold">$${order.total?.toFixed(2) || '0.00'}</div>
                            </div>
                            <div>
                                <div class="text-gray-400 text-sm">–¢–æ–≤–∞—Ä–æ–≤</div>
                                <div>${order.items?.length || 0} —à—Ç.</div>
                            </div>
                        </div>

                        <div class="bg-gray-700 p-3 rounded mb-4 text-sm max-h-24 overflow-y-auto">
                            <div class="text-gray-400 mb-2">üì¶ –¢–æ–≤–∞—Ä—ã:</div>
                            <div class="space-y-1 text-gray-300">
                                ${(order.items || []).map(item => `
                                    <div>‚Ä¢ ${item.name} x${item.quantity} = $${(item.price * item.quantity).toFixed(2)}</div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="border-t border-gray-700 pt-4 mt-4">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                                <div>
                                    <div class="text-gray-400 text-sm mb-2">–°—Ç–∞—Ç—É—Å</div>
                                    <select 
                                        class="status-select w-full px-3 py-2 bg-gray-700 rounded text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                                        data-order-id="${order.orderId}"
                                        data-user-id="${order.userId}"
                                        value="${order.status || 'pending'}"
                                    >
                                        <option value="pending">‚è≥ –í –æ–∂–∏–¥–∞–Ω–∏–∏</option>
                                        <option value="completed">‚úì –í—ã–ø–æ–ª–Ω–µ–Ω</option>
                                        <option value="cancelled">‚úó –û—Ç–º–µ–Ω–µ–Ω</option>
                                    </select>
                                </div>
                                <div>
                                    <button 
                                        class="update-status-btn w-full bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded transition font-semibold text-sm"
                                        data-order-id="${order.orderId}"
                                        data-user-id="${order.userId}"
                                    >
                                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                    </button>
                                </div>
                                <div>
                                    <button 
                                        class="delete-order-btn w-full bg-red-600 hover:bg-red-700 px-3 py-2 rounded transition font-semibold text-sm"
                                        data-order-id="${order.orderId}"
                                        data-user-id="${order.userId}"
                                    >
                                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                                    </button>
                                </div>
                                <div>
                                    <div class="text-gray-400 text-sm mb-2">–°—Ç–∞—Ç—É—Å</div>
                                    <div class="px-3 py-2 bg-gray-700 rounded text-sm">
                                        ${order.status === 'completed' ? '‚úì –í—ã–ø–æ–ª–Ω–µ–Ω' : order.status === 'pending' ? '‚è≥ –í –æ–∂–∏–¥–∞–Ω–∏–∏' : '‚úó –û—Ç–º–µ–Ω–µ–Ω'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                // –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
                document.querySelectorAll('.update-status-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const orderId = e.target.getAttribute('data-order-id');
                        const userId = e.target.getAttribute('data-user-id');
                        const selectElement = e.target.closest('.bg-gray-800').querySelector('.status-select');
                        const newStatus = selectElement.value;

                        console.log('[Orders] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞:', orderId, '‚Üí', newStatus);
                        
                        e.target.disabled = true;
                        e.target.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

                        const result = await updateOrderStatus(userId, orderId, newStatus);
                        
                        if (result.success) {
                            console.log('[Orders] ‚úÖ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω');
                            e.target.textContent = '‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
                            setTimeout(() => {
                                e.target.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                                e.target.disabled = false;
                            }, 2000);
                        } else {
                            console.error('[Orders] ‚ùå –û—à–∏–±–∫–∞:', result.error);
                            alert('‚ùå –û—à–∏–±–∫–∞: ' + result.error);
                            e.target.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                            e.target.disabled = false;
                        }
                    });
                });

                // –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
                document.querySelectorAll('.delete-order-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const orderId = e.target.getAttribute('data-order-id');
                        const userId = e.target.getAttribute('data-user-id');

                        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –ó–∞–∫–∞–∑ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω –Ω–∞–≤—Å–µ–≥–¥–∞!')) {
                            return;
                        }

                        console.log('[Orders] –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞:', orderId);
                        
                        e.target.disabled = true;
                        e.target.textContent = '–£–¥–∞–ª—è—é...';

                        const result = await deleteOrder(userId, orderId);
                        
                        if (result.success) {
                            console.log('[Orders] ‚úÖ –ó–∞–∫–∞–∑ —É–¥–∞–ª–µ–Ω');
                            e.target.closest('.bg-gray-800').remove();
                        } else {
                            console.error('[Orders] ‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', result.error);
                            alert('‚ùå –û—à–∏–±–∫–∞: ' + result.error);
                            e.target.textContent = 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å';
                            e.target.disabled = false;
                        }
                    });
                });
            }

            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
            document.getElementById('search-input').addEventListener('input', filterOrders);
            document.getElementById('status-filter').addEventListener('change', filterOrders);

            function filterOrders() {
                const searchText = document.getElementById('search-input').value.toLowerCase();
                const statusFilter = document.getElementById('status-filter').value;

                const filtered = allOrders.filter(order => {
                    const matchesSearch = (order.orderId?.includes(searchText) || order.userId?.includes(searchText));
                    const matchesStatus = !statusFilter || order.status === statusFilter;
                    return matchesSearch && matchesStatus;
                });

                renderOrders(filtered);
            }

            // –í—ã—Ö–æ–¥
            document.getElementById('logout-btn').addEventListener('click', async () => {
                const result = await logoutUser();
                if (result.success) {
                    console.log('[Orders] –£—Å–ø–µ—à–Ω—ã–π –≤—ã—Ö–æ–¥');
                    window.location.href = 'login.html';
                }
            });

            console.log('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞–º–∏ –≥–æ—Ç–æ–≤–∞');
        } catch (error) {
            console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
            alert('–û—à–∏–±–∫–∞: ' + error.message);
        }
    </script>
</body>
</html>
